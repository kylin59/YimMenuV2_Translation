name: Auto Build

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  create-release:
    name: Auto Build
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
      
    - name: Clone YimMenuV2
      shell: bash
      run: |
        git clone --recursive https://github.com/YimMenu/YimMenuV2.git
        cd YimMenuV2
        echo "当前版本: $(git describe --tags 2>/dev/null || git rev-parse --short HEAD)"
        
    - name: Apply patches and process
      shell: bash
      run: |
        set -e
        
        cd YimMenuV2
        
        # 复制文件
        cp ../*.py . 2>/dev/null || true
        cp ../*.TTF . 2>/dev/null || true
        
        # 处理补丁文件
        if [ -f ../patch.diff ]; then
            echo "找到补丁文件，开始处理..."
            cp ../patch.diff .
            dos2unix patch.diff
            
            # 尝试应用补丁
            echo "尝试应用补丁..."
            if git apply --check patch.diff 2>/dev/null; then
                git apply patch.diff
                echo "补丁应用成功"
            else
                echo "补丁检查失败，创建拒绝文件"
                git apply --reject patch.diff 2>&1 | tail -20
                
                # 如果有拒绝文件，显示信息
                if ls *.rej 1> /dev/null 2>&1; then
                    echo "有以下拒绝文件:"
                    ls *.rej
                    echo "可能需要手动合并这些文件"
                fi
            fi
        else
            echo "未找到 patch.diff，跳过补丁步骤"
        fi
        
        # 处理字体
        if [ -f font.py ]; then
            echo "生成字体文件..."
            python font.py
            if [ -f MainFont.cpp ]; then
                mkdir -p src/game/frontend/fonts
                mv MainFont.cpp src/game/frontend/fonts/
                echo "字体文件移动完成"
            fi
        fi
        
    - name: Translate YimMenuV2
      shell: bash
      run: |
        python update_translation.py
        python translate.py
    
    # ... 其他步骤保持不变
